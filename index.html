<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JSON 在线格式化工具</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f5f6fa;
        --panel: #fff;
        --border: #e3e5ed;
        --text: #1f2633;
        --muted: #6c7485;
        --accent: #1f7aec;
        --danger: #f04438;
        --success: #12b886;
        --font-mono: "Fira Code", "Consolas", "Monaco", "SFMono-Regular", monospace;
        --font-sans: "Segoe UI", "PingFang SC", "Helvetica Neue", Arial, sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: var(--font-sans);
        color: var(--text);
        background: var(--bg);
        display: flex;
        flex-direction: column;
      }

      header {
        padding: 20px clamp(16px, 4vw, 48px) 10px;
        font-size: 18px;
        font-weight: 600;
      }

      header span {
        display: block;
        font-size: 13px;
        font-weight: 400;
        color: var(--muted);
        margin-top: 4px;
      }

      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 0 clamp(16px, 4vw, 48px) 16px;
      }

      button {
        appearance: none;
        border: 1px solid transparent;
        border-radius: 6px;
        padding: 8px 16px;
        font-size: 14px;
        background: var(--panel);
        color: var(--text);
        cursor: pointer;
        box-shadow: 0 1px 2px rgba(31, 38, 51, 0.08);
        transition: transform 120ms ease, box-shadow 120ms ease;
      }

      button.primary {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 14px rgba(31, 38, 51, 0.2);
      }

      button:active {
        transform: translateY(0);
      }

      main {
        flex: 1;
        display: flex;
        gap: 16px;
        padding: 0 clamp(16px, 4vw, 48px) clamp(16px, 3vw, 32px);
      }

      .panel {
        flex: 1 1 50%;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 12px 30px rgba(31, 38, 51, 0.1);
        min-width: 0;
      }

      .panel-header {
        padding: 14px 18px;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      textarea {
        flex: 1;
        width: 100%;
        resize: none;
        border: none;
        outline: none;
        font-family: var(--font-mono);
        font-size: 14px;
        padding: 16px 18px;
        line-height: 1.5;
        color: var(--text);
        white-space: pre;
        overflow: auto;
      }

      textarea::placeholder {
        color: var(--muted);
      }

      .status {
        padding: 10px 18px;
        border-top: 1px solid var(--border);
        font-size: 13px;
        color: var(--muted);
        min-height: 40px;
      }

      .status.success {
        color: var(--success);
      }

      .status.error {
        color: var(--danger);
      }

      #tree-view {
        flex: 1;
        padding: 16px 18px 18px;
        overflow: auto;
        font-family: var(--font-mono);
        font-size: 13px;
        white-space: pre;
      }

      .placeholder {
        color: var(--muted);
        text-align: center;
        margin-top: 40%;
      }

      details {
        border-left: 2px solid transparent;
        padding-left: 12px;
        margin-bottom: 6px;
      }

      details[open] {
        border-color: var(--border);
      }

      summary {
        cursor: pointer;
        list-style: none;
        outline: none;
      }

      summary::marker {
        display: none;
      }

      summary::-webkit-details-marker {
        display: none;
      }

      .summary-content {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .node-label {
        font-weight: 600;
      }

      .node-type {
        font-size: 11px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .node-value {
        display: block;
        padding: 4px 0 4px 16px;
        color: var(--text);
        white-space: pre;
        overflow: auto;
      }

      .token {
        font-family: var(--font-mono);
      }

      .token-key {
        color: #2563eb;
      }

      .token-string {
        color: #0f9d58;
      }

      .token-number {
        color: #d92d20;
      }

      .token-boolean {
        color: #a855f7;
      }

      .token-null {
        color: #ef6820;
      }

      .token-punctuation {
        color: var(--muted);
      }

      @media (max-width: 960px) {
        main {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <header>
      JSON 在线格式化工具
      <span>轻量纯前端实现</span>
    </header>

    <section class="toolbar">
      <button class="primary" id="format-btn">格式化</button>
      <button id="compact-btn">压缩</button>
      <button id="unescape-btn">去除转义</button>
      <button id="escape-btn">添加转义</button>
      <button id="cn2unicode-btn">中文转 Unicode</button>
      <button id="unicode2cn-btn">Unicode 转中文</button>
      <button id="clear-btn">清空</button>
      <button id="copy-btn">复制结果</button>
    </section>

    <main>
      <section class="panel">
        <div class="panel-header">
          输入区
          <span style="font-weight: 400; color: var(--muted); font-size: 13px"
            >支持中文与 Unicode</span
          >
        </div>
        <textarea
          id="json-input"
          spellcheck="false"
          placeholder='在此粘贴或输入 JSON，例如：{"name":"BeJSON","features":["format","tree"]}'
        ></textarea>
        <div class="status" id="status">等待输入…</div>
      </section>

      <section class="panel">
        <div class="panel-header">
          结果树视图
          <div style="font-size: 12px; color: var(--muted)">自动展开根节点</div>
        </div>
        <div id="tree-view">
          <div class="placeholder">请在左侧输入 JSON</div>
        </div>
      </section>
    </main>

    <script>
      const inputEl = document.getElementById("json-input");
      const treeView = document.getElementById("tree-view");
      const statusEl = document.getElementById("status");

      const HISTORY_LIMIT = 200;
      const history = {
        stack: [],
        index: -1,
        push(value) {
          if (this.index >= 0 && this.stack[this.index] === value) {
            return;
          }
          if (this.index < this.stack.length - 1) {
            this.stack = this.stack.slice(0, this.index + 1);
          }
          this.stack.push(value);
          if (this.stack.length > HISTORY_LIMIT) {
            this.stack.shift();
            this.index = this.stack.length - 1;
          } else {
            this.index += 1;
          }
        },
        undo() {
          if (this.index <= 0) return null;
          this.index -= 1;
          return this.stack[this.index];
        },
        redo() {
          if (this.index >= this.stack.length - 1) return null;
          this.index += 1;
          return this.stack[this.index];
        },
      };

      history.push(inputEl.value || "");

      document.getElementById("format-btn").addEventListener("click", () => {
        const canProceed = removeEscapes({ silent: true });
        if (canProceed) {
          formatJson(2);
        }
      });
      document
        .getElementById("compact-btn")
        .addEventListener("click", () => formatJson(0));
      document
        .getElementById("unescape-btn")
        .addEventListener("click", removeEscapes);
      document
        .getElementById("escape-btn")
        .addEventListener("click", addEscapes);
      document
        .getElementById("cn2unicode-btn")
        .addEventListener("click", toUnicode);
      document
        .getElementById("unicode2cn-btn")
        .addEventListener("click", fromUnicode);
      document
        .getElementById("clear-btn")
        .addEventListener("click", () => {
          setInputValue("");
          treeView.innerHTML =
            '<div class="placeholder">请在左侧输入 JSON</div>';
          updateStatus("内容已清空", "muted");
        });
      document.getElementById("copy-btn").addEventListener("click", copyJson);

      inputEl.addEventListener("input", () => {
        history.push(inputEl.value);
      });

      inputEl.addEventListener("keydown", (event) => {
        if (event.key.toLowerCase() !== "z" || !event.ctrlKey) {
          return;
        }
        event.preventDefault();
        if (event.shiftKey) {
          const redoValue = history.redo();
          if (redoValue !== null) {
            applyHistoryValue(redoValue);
            updateStatus("已前进一步", "success");
          }
          return;
        }
        const undoValue = history.undo();
        if (undoValue !== null) {
          applyHistoryValue(undoValue);
          updateStatus("已回退一步", "success");
        }
      });

      function formatJson(indent = 2) {
        const raw = inputEl.value.trim();
        if (!raw) {
          updateStatus("请输入 JSON 内容", "muted");
          return;
        }

        try {
          const parsed = JSON.parse(raw);
          const formatted = indent
            ? JSON.stringify(parsed, null, indent)
            : JSON.stringify(parsed);
          setInputValue(formatted);
          renderTree(parsed);
          updateStatus("格式化成功", "success");
        } catch (error) {
          updateStatus(`JSON 解析失败：${error.message}`, "error");
        }
      }

      function renderTree(value) {
        treeView.innerHTML = "";
        const rootNode = createBranch(value, "ROOT");
        rootNode.open = true;
        treeView.appendChild(rootNode);
      }

      function createBranch(value, label) {
        if (isPlainValue(value)) {
          return createValueRow(label, value);
        }

        const branch = document.createElement("details");
        branch.open = true;

        const summary = document.createElement("summary");
        const summaryContent = document.createElement("span");
        summaryContent.className = "summary-content";

        const name = document.createElement("span");
        name.className = "node-label token token-key";
        name.textContent = label;

        const type = document.createElement("span");
        type.className = "node-type";
        type.textContent = describe(value);

        summaryContent.appendChild(name);
        summaryContent.appendChild(type);
        summary.appendChild(summaryContent);
        branch.appendChild(summary);

        const entries = Array.isArray(value)
          ? value.map((item, index) => [index, item])
          : Object.entries(value);

        if (!entries.length) {
          const empty = document.createElement("div");
          empty.className = "node-value";
          empty.style.color = "var(--muted)";
          empty.textContent = "（空）";
          branch.appendChild(empty);
          return branch;
        }

        entries.forEach(([key, val]) => {
          branch.appendChild(createBranch(val, key));
        });

        return branch;
      }

      function createValueRow(label, value) {
        const row = document.createElement("div");
        row.className = "node-value";

        row.appendChild(createToken(label, "token token-key"));
        row.appendChild(createToken(":", "token token-punctuation"));
        row.appendChild(buildValueToken(value));

        return row;
      }

      function isPlainValue(val) {
        return (
          typeof val !== "object" ||
          val === null ||
          val instanceof Date ||
          val instanceof RegExp
        );
      }

      function describe(val) {
        if (Array.isArray(val)) {
          return `Array · ${val.length}`;
        }
        if (val === null) {
          return "Null";
        }
        return `Object · ${Object.keys(val).length}`;
      }

      function formatValue(val) {
        if (typeof val === "string") {
          return `"${val}"`;
        }
        if (val === null) {
          return "null";
        }
        return String(val);
      }

      function buildValueToken(val) {
        const typeClass = getValueTokenClass(val);
        const span = createToken(formatValue(val), `token ${typeClass}`);
        return span;
      }

      function getValueTokenClass(val) {
        if (val === null) return "token-null";
        switch (typeof val) {
          case "string":
            return "token-string";
          case "number":
            return "token-number";
          case "boolean":
            return "token-boolean";
          default:
            return "token-key";
        }
      }

      function createToken(text, className) {
        const span = document.createElement("span");
        span.className = className;
        span.textContent = text;
        return span;
      }

      async function copyJson() {
        try {
          if (!inputEl.value.trim()) {
            updateStatus("没有可复制的内容", "muted");
            return;
          }
          await navigator.clipboard.writeText(inputEl.value);
          updateStatus("已复制到剪贴板", "success");
        } catch (error) {
          updateStatus("复制失败，请手动选择文本复制", "error");
        }
      }

      function updateStatus(message, type) {
        statusEl.textContent = message;
        statusEl.className = `status ${type || ""}`;
      }

      function setInputValue(value, { recordHistory = true } = {}) {
        inputEl.value = value;
        resetInputScroll();
        if (recordHistory) {
          history.push(value);
        }
      }

      function applyHistoryValue(value) {
        inputEl.value = value;
        resetInputScroll();
        safeRenderJson(value);
      }

      function removeEscapes(options = {}) {
        const { silent = false } = options;
        const raw = inputEl.value;
        if (!raw) {
          if (!silent) {
            updateStatus("没有可处理的内容", "muted");
          }
          return true;
        }

        if (isValidJson(raw)) {
          if (!silent) {
            updateStatus("当前内容已是合法 JSON，无需去除转义", "muted");
          }
          return true;
        }

        if (!raw.includes("\\")) {
          if (!silent) {
            updateStatus("未检测到需要去除的转义字符", "muted");
          }
          return true;
        }

        try {
          const unescaped = decodeJsonEscapes(raw);
          setInputValue(unescaped);
          if (!silent) {
            updateStatus("已去除转义", "success");
          }
          safeRenderJson(unescaped);
          return true;
        } catch (error) {
          updateStatus(`去除转义失败：${error.message}`, "error");
          return false;
        }
      }

      function addEscapes() {
        const raw = inputEl.value;
        if (!raw) {
          updateStatus("没有可处理的内容", "muted");
          return;
        }

        try {
          const escaped = JSON.stringify(raw).slice(1, -1);
          setInputValue(escaped);
          updateStatus("已添加转义字符", "success");
        } catch (error) {
          updateStatus(`添加转义失败：${error.message}`, "error");
        }
      }

      function decodeJsonEscapes(str) {
        const escapeMap = {
          '"': '"',
          "\\": "\\",
          "/": "/",
          b: "\b",
          f: "\f",
          n: "\n",
          r: "\r",
          t: "\t",
        };

        return str.replace(/\\(u[0-9a-fA-F]{4}|["\\/bfnrt])/g, (_, token) => {
          if (token.startsWith("u")) {
            return String.fromCharCode(parseInt(token.slice(1), 16));
          }
          return escapeMap[token] ?? token;
        });
      }

      function safeRenderJson(text) {
        try {
          const parsed = JSON.parse(text);
          renderTree(parsed);
        } catch (_) {
          /* ignore */
        }
      }

      function toUnicode() {
        const raw = inputEl.value;
        if (!raw) {
          updateStatus("没有可处理的内容", "muted");
          return;
        }
        const converted = raw.replace(
          /[\u0080-\uFFFF]/g,
          (char) => "\\u" + char.charCodeAt(0).toString(16).padStart(4, "0")
        );
        setInputValue(converted);
        updateStatus("已转换为 Unicode 转义", "success");
      }

      function fromUnicode() {
        const raw = inputEl.value;
        if (!raw) {
          updateStatus("没有可处理的内容", "muted");
          return;
        }
        const converted = raw.replace(
          /\\u([0-9a-fA-F]{4})/g,
          (_, code) => String.fromCharCode(parseInt(code, 16))
        );
        setInputValue(converted);
        updateStatus("已将 Unicode 转义还原为中文", "success");
        safeRenderJson(converted);
      }

      function resetInputScroll() {
        inputEl.scrollLeft = 0;
        inputEl.scrollTop = 0;
      }

      function isValidJson(text) {
        try {
          JSON.parse(text);
          return true;
        } catch (_) {
          return false;
        }
      }
    </script>
  </body>
</html>

